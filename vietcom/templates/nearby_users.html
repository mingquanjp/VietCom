{% extends 'base.html' %}
{% load static %}

{% block title %}Find Nearby Friends üåç{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #map {
            height: 400px;
            width: 100%;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
      .main-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .radar-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 20px auto;
        border-radius: 50%;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7);
        }
        70% {
          transform: scale(1.1);
          box-shadow: 0 0 0 20px rgba(255, 107, 107, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
        }
      }

      .radar-inner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 150px;
        height: 150px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
      }

      .controls-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .user-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .user-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .user-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
      }

      .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      }

      .distance-badge {
        background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        color: white;
        padding: 5px 15px;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: bold;
      }

      .status-online {
        width: 15px;
        height: 15px;
        background: #4ecdc4;
        border-radius: 50%;
        position: absolute;
        bottom: 5px;
        right: 5px;
        border: 2px solid white;
        animation: blink 2s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.3;
        }
      }

      .action-btn {
        border: none;
        border-radius: 25px;
        padding: 8px 20px;
        font-weight: bold;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn-friend {
        background: linear-gradient(45deg, #4ecdc4, #44b3aa);
        color: white;
      }

      .btn-message {
        background: linear-gradient(45deg, #45b7d1, #3a9bc1);
        color: white;
      }

      .btn-friend:hover,
      .btn-message:hover {
        transform: scale(1.05);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(45deg, #ffc107, #e0a800);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #28a745, #1e7e34);
        color: white;
      }

      .btn-info {
        background: linear-gradient(45deg, #17a2b8, #138496);
        color: white;
      }

      .notification-popup {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
      }

      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }

      .range-slider {
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
        height: 8px;
        border-radius: 4px;
        outline: none;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .no-users {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .cute-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.7;
      }

      .level-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
      }

      .radius-display {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px;
        margin-top: 8px;
      }

      .radius-bar {
        background: linear-gradient(90deg, #4ecdc4 0%, #44a08d 100%);
        height: 25px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3);
        position: relative;
        overflow: hidden;
      }

      .radius-text {
        color: white;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        font-size: 0.9rem;
      }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
      <!-- Header -->
      <div class="header-card">
        <h1 class="mb-3">üåç Find Nearby Friends</h1>
        <p class="text-muted">Discover amazing people around you!</p>

        <div class="radar-container">
          <div class="radar-inner">üéØ</div>
        </div>

        <p class="mb-0">
          <span class="badge bg-primary"
            >{{ nearby_users|length }} people found</span
          >
          <span class="badge bg-info"
            >{{ current_user.search_radius }}km radius</span
          >
        </p>
      </div>

      <!-- Controls -->
      <div class="controls-card">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="level-info mb-3">
              <h5 class="text-primary mb-2">
                <i class="fas fa-trophy text-warning"></i> Level {{ user_level }}
              </h5>
              <p class="text-muted mb-1">
                <i class="fas fa-crosshairs text-primary"></i>
                Search Radius: <strong>{{ search_radius }}km</strong>
              </p>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">
                <i class="fas fa-arrow-up text-success"></i>
                Next Level {{ next_level }}: {{ next_level_radius }}km radius
              </p>
              <small class="text-warning">
                <i class="fas fa-star"></i> Level up to expand your search area!
              </small>
            </div>
          </div>
          <div class="col-md-6">
            <label for="radiusRange" class="form-label">
              <i class="fas fa-search text-primary"></i>
              Current Range: <span id="radiusValue">{{ search_radius }}</span>km
              <small class="text-muted">(Based on Level {{ user_level }})</small>
            </label>
            <div class="radius-display">
              <div class="radius-bar">
                <span class="radius-text">{{ search_radius }}km</span>
              </div>
            </div>
          </div>
          <div class="col-md-6 text-end">
            <button
              class="btn btn-primary btn-lg"
              onclick="refreshLocation()"
              id="refreshBtn"
            >
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
      </div>

      <div id="map"></div>

      <!-- Loading Spinner -->
      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Scanning for nearby friends...</p>
      </div>

      <!-- Users List -->
      <div id="usersList">
        {% if nearby_users %}
{% for user_data in nearby_users %}
        <div class="user-card">
          <div class="row align-items-center">
            <div class="col-md-2 text-center">
              <div class="position-relative d-inline-block">
                <img
                  src="#"
                  alt="{{ user_data.user.full_name }}"
                  class="user-avatar"
                />
                {% if user_data.user.status == 'online' %}
                <div class="status-online"></div>
                {% endif %}
              </div>
            </div>

            <div class="col-md-6">
              <h5 class="mb-1">
                {{ user_data.user.full_name|default:user_data.user.username }}
                {% if user_data.user.gender == 'male' %}üë®{% elif
                user_data.user.gender == 'female' %}üë©{% else %}üë§{% endif %}
              </h5>
              <p class="text-muted mb-2">
                üìç {{ user_data.user.hometown|default:"Unknown location" }}
              </p>
              {% if user_data.user.bio %}
              <p class="small text-secondary mb-0">
                üí≠ {{ user_data.user.bio|truncatechars:100 }}
              </p>
              {% endif %}
            </div>

            <div class="col-md-2 text-center">
              <span class="distance-badge">
                üìè {{ user_data.distance|floatformat:1 }}km
              </span>
              <div class="mt-2">
                <small class="text-muted"
                  >Level {{ user_data.user.level }}</small
                >
              </div>
            </div>

            <div class="col-md-2 text-center">
              {% if user_data.friend_status == 'friends' %}
                <button class="action-btn btn-success" disabled>
                  <i class="fas fa-check"></i> Friends
                </button>
              {% elif user_data.friend_status == 'sent' %}
                <button 
                  class="action-btn btn-warning" 
                  onclick="cancelFriendRequest('{{ user_data.request_id }}')"
                  id="friend-btn-{{ user_data.user.id }}"
                >
                  <i class="fas fa-clock"></i> Sent
                </button>
              {% elif user_data.friend_status == 'received' %}
                <button 
                  class="action-btn btn-info" 
                  onclick="showRequestActions('{{ user_data.request_id }}')"
                >
                  <i class="fas fa-user-clock"></i> Respond
                </button>
              {% else %}
                <button
                  class="action-btn btn-friend"
                  onclick="addFriend('{{ user_data.user.id }}')"
                  id="friend-btn-{{ user_data.user.id }}"
                >
                  <i class="fas fa-user-plus"></i> Add
                </button>
              {% endif %}
              <br />
              {% if user_data.friend_status == 'friends' %}
                <button
                  class="action-btn btn-message"
                  onclick="sendMessage('{{ user_data.user.id }}')"
                >
                  <i class="fas fa-comment"></i> Chat
                </button>
              {% else %}
                <button class="action-btn btn-message" disabled>
                  <i class="fas fa-comment"></i> Chat
                </button>
              {% endif %}
                <i class="fas fa-comment"></i> Chat
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
{% else %}
        <div class="no-users">
          <div class="cute-icon">üîç</div>
          <h4>No friends found nearby</h4>
          <p class="text-muted">
            Try increasing your search radius or check your location settings!
          </p>
          <button class="btn btn-primary" onclick="updateLocationAndRefresh()">
            <i class="fas fa-location-arrow"></i> Update My Location
          </button>
        </div>
        {% endif %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let isUpdating = false;


    const nearbyUsers = JSON.parse('{{ map_users_json|escapejs }}');
    const currentUser = JSON.parse('{{ current_user_json|escapejs }}');
    let map = null; // Bi·∫øn ƒë·ªÉ l∆∞u ƒë·ªëi t∆∞·ª£ng b·∫£n ƒë·ªì
    let searchRadiusCircle = null; // Bi·∫øn ƒë·ªÉ l∆∞u v√≤ng tr√≤n b√°n k√≠nh t√¨m ki·∫øm

    function initializeMap() {
        // Ki·ªÉm tra n·∫øu ng∆∞·ªùi d√πng hi·ªán t·∫°i c√≥ t·ªça ƒë·ªô
        if (!currentUser.latitude || !currentUser.longitude) {
            document.getElementById('map').innerHTML = '<div class="p-4 text-center text-muted">Vui l√≤ng c·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa b·∫°n ƒë·ªÉ xem b·∫£n ƒë·ªì.</div>';
            return;
        }

        // Kh·ªüi t·∫°o map v√† ƒë·∫∑t view v√†o v·ªã tr√≠ c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i
        map = L.map('map').setView([currentUser.latitude, currentUser.longitude], 13);

        // Th√™m l·ªõp tile layer t·ª´ OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // T·∫°o icon t√πy ch·ªânh cho ng∆∞·ªùi d√πng hi·ªán t·∫°i
        const currentUserIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3037/3037402.png', // M·ªôt icon v·ªã tr√≠ ƒë·∫∑c bi·ªát
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -40]
        });

        // ƒê√°nh d·∫•u v·ªã tr√≠ ng∆∞·ªùi d√πng hi·ªán t·∫°i
        L.marker([currentUser.latitude, currentUser.longitude], {icon: currentUserIcon}).addTo(map)
            .bindPopup('<b>V·ªã tr√≠ c·ªßa b·∫°n</b>')
            .openPopup();

        // V·∫Ω v√≤ng tr√≤n b√°n k√≠nh t√¨m ki·∫øm
        searchRadiusCircle = L.circle([currentUser.latitude, currentUser.longitude], {
            color: '#45b7d1',
            fillColor: '#45b7d1',
            fillOpacity: 0.1,
            radius: currentUser.search_radius * 1000 // Chuy·ªÉn t·ª´ km sang m√©t
        }).addTo(map);

        // Th√™m c√°c marker cho ng∆∞·ªùi d√πng g·∫ßn ƒë√≥
        nearbyUsers.forEach(user => {
            const userIcon = L.icon({
                iconUrl: user.avatar_url,
                iconSize: [35, 35],
                className: 'user-map-avatar' // Th√™m class ƒë·ªÉ style n·∫øu mu·ªën
            });

            const marker = L.marker([user.latitude, user.longitude]).addTo(map);
            
            // T·∫°o popup hi·ªÉn th·ªã th√¥ng tin khi click
            const popupContent = `
                <div class="text-center">
                    <img src="${user.avatar_url}" alt="${user.full_name}" width="50" class="rounded-circle mb-2">
                    <h5>${user.full_name}</h5>
                    <p class="mb-2">C√°ch b·∫°n ~${user.distance} km</p>
                    <button class="btn btn-sm btn-friend" onclick="addFriend('${user.id}')"><i class="fas fa-user-plus"></i> Add</button>
                    <button class="btn btn-sm btn-message" onclick="sendMessage('${user.id}')"><i class="fas fa-comment"></i> Chat</button>
                </div>
            `;
            marker.bindPopup(popupContent);
        });
    }

    // G·ªçi h√†m kh·ªüi t·∫°o map khi trang t·∫£i xong
    document.addEventListener('DOMContentLoaded', initializeMap);

      // Level-based radius - no manual update needed
      function updateRadius(value) {
        // Radius is now based on user level, not manual input
        console.log("Radius is determined by user level:", "{{ search_radius }}");
      }

      function updateMapRadius(radiusKm) {
        // C·∫≠p nh·∫≠t v√≤ng tr√≤n b√°n k√≠nh tr√™n map
        if (searchRadiusCircle && map) {
          searchRadiusCircle.setRadius(radiusKm * 1000); // Chuy·ªÉn t·ª´ km sang m√©t
        }
      }

      function updateSearchRadius(radius) {
        if (isUpdating) return;
        isUpdating = true;

        fetch("/users/update-search-radius/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ radius: radius }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // C·∫≠p nh·∫≠t currentUser.search_radius v·ªõi gi√° tr·ªã m·ªõi
              currentUser.search_radius = radius;
              refreshNearbyUsers();
            }
          })
          .finally(() => {
            isUpdating = false;
          });
      }

      function refreshLocation() {
        const btn = document.getElementById("refreshBtn");
        const spinner = document.getElementById("loadingSpinner");

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        spinner.style.display = "block";

        if ("geolocation" in navigator) {
          // Options for high accuracy location
          const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0 // Don't use cached location
          };
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              console.log("üìç Location obtained:", position.coords.latitude, position.coords.longitude);
              console.log("üéØ Accuracy:", position.coords.accuracy, "meters");
              
              updateUserLocation(
                position.coords.latitude,
                position.coords.longitude
              );
            },
            (error) => {
              console.error("‚ùå Location error:", error);
              let errorMessage = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i. ";
              switch(error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage += "Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ trong tr√¨nh duy·ªát.";
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage += "Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.";
                  break;
                case error.TIMEOUT:
                  errorMessage += "Y√™u c·∫ßu l·∫•y v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian.";
                  break;
                default:
                  errorMessage += "L·ªói kh√¥ng x√°c ƒë·ªãnh.";
                  break;
              }
              console.warn(errorMessage);
              refreshNearbyUsers();
            },
            geoOptions
          );
        } else {
          refreshNearbyUsers();
        }
      }

      function updateUserLocation(lat, lng) {
        console.log("üì§ Sending location update to server:", lat, lng);
        
        fetch("/users/update-location/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ latitude: lat, longitude: lng }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("‚úÖ Location updated successfully on server");
              refreshNearbyUsers();
            } else {
              console.error("‚ùå Failed to update location:", data.message);
            }
          })
          .catch((error) => {
            console.error("‚ùå Network error updating location:", error);
          });
      }

      function updateMapWithNewData() {
        console.log("üó∫Ô∏è Updating map with new data without page reload");
        // Map will be updated by the refreshNearbyUsers function
        // This prevents the page reload while keeping data fresh
      }

      function refreshNearbyUsers() {
        fetch("/users/nearby/")
          .then((response) => response.text())
          .then((html) => {
            // Update the users list
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, "text/html");
            const newUsersList = newDoc.getElementById("usersList");
            
            if (newUsersList) {
              document.getElementById("usersList").innerHTML = newUsersList.innerHTML;
              console.log("‚úÖ Updated nearby users list without page reload");
            }
            
            // Update map data without reload by re-initializing
            updateMapWithNewData();
          })
          .finally(() => {
            document.getElementById("refreshBtn").disabled = false;
            document.getElementById("refreshBtn").innerHTML =
              '<i class="fas fa-sync-alt"></i> Refresh';
            document.getElementById("loadingSpinner").style.display = "none";
          });
      }

      function addFriend(userId) {
        fetch("/social/send-friend-request/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ user_id: userId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("üéâ Friend request sent!");
            } else {
              alert("‚ùå " + data.message);
            }
          });
      }

      function sendMessage(userId) {
        window.location.href = `/social/chat/${userId}/`;
      }

      function updateLocationAndRefresh() {
        refreshLocation();
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Auto-detect location when page loads for better accuracy
      function autoDetectLocation() {
        console.log("üîç Auto-detecting location for better accuracy...");
        
        if ("geolocation" in navigator) {
          const geoOptions = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0 // Always get fresh location
          };
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const accuracy = Math.round(position.coords.accuracy);
              console.log("üìç Auto-detected location:", position.coords.latitude, position.coords.longitude);
              console.log("üéØ Accuracy:", accuracy, "meters");
              
              // Always update location, but warn if accuracy is poor
              if (accuracy > 500) {
                console.warn("‚ö†Ô∏è Location accuracy is poor:", accuracy, "meters");
                console.log("üí° Try moving to an open area or enabling high accuracy GPS");
              } else {
                console.log("‚úÖ Good location accuracy:", accuracy, "meters");
              }
              
              updateUserLocation(
                position.coords.latitude,
                position.coords.longitude
              );
            },
            (error) => {
              console.warn("‚ö†Ô∏è Auto location detection failed:", error.message);
              console.log("üí° You can manually refresh location using the Refresh button");
            },
            geoOptions
          );
        } else {
          console.error("‚ùå Geolocation not supported by this browser");
        }
      }

      // Run auto-detection when page loads
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for page to fully load
        setTimeout(autoDetectLocation, 1000);
      });

      // Friend Request Functions
      function addFriend(userId) {
        const btn = document.getElementById(`friend-btn-${userId}`);
        const originalContent = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        
        fetch('/social/send-friend-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            btn.className = 'action-btn btn-warning';
            btn.innerHTML = '<i class="fas fa-clock"></i> Sent';
            btn.onclick = () => cancelFriendRequest(data.request_id);
            showNotification(data.message, 'success');
          } else {
            btn.disabled = false;
            btn.innerHTML = originalContent;
            showNotification(data.message, 'error');
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.innerHTML = originalContent;
          showNotification('Error sending friend request', 'error');
        });
      }
      
      function cancelFriendRequest(requestId) {
        if (!confirm('Cancel friend request?')) return;
        
        fetch('/social/cancel-friend-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ request_id: requestId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload(); // Refresh to update UI
          } else {
            showNotification(data.message, 'error');
          }
        });
      }
      
      function showRequestActions(requestId) {
        if (confirm('Accept this friend request?')) {
          respondToRequest(requestId, 'accept');
        } else if (confirm('Reject this friend request?')) {
          respondToRequest(requestId, 'reject');
        }
      }
      
      function respondToRequest(requestId, action) {
        fetch('/social/respond-friend-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 
            request_id: requestId, 
            action: action 
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification(data.message, 'success');
            location.reload(); // Refresh to update UI
          } else {
            showNotification(data.message, 'error');
          }
        });
      }
      
      function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} notification-popup`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 300px;
          animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
          ${message}
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // Reduced auto-refresh to every 5 minutes to avoid interference
      setInterval(refreshNearbyUsers, 300000);
    </script>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
