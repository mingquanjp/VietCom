{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
/* Level Control Panel */
.level-control-panel {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border-radius: 20px;
  padding: 15px 25px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  border: 2px solid #e3f2fd;
  z-index: 999;
  display: flex;
  align-items: center;
  gap: 20px;
  min-width: 600px;
  backdrop-filter: blur(10px);
}

.level-info {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.level-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 16px;
  color: #BC0126;
}

.level-icon {
  font-size: 18px;
}

.search-info {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: #BC0126;
}

.search-icon {
  font-size: 14px;
}

.level-progress {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.progress-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.range-text {
  font-size: 13px;
  font-weight: 600;
  color: #BC0126;
}

.next-level {
  font-size: 12px;
  color: #BC0126;
}

.level-up-hint {
  font-size: 11px;
  color: #BC0126;
  font-weight: 500;
}

.progress-bar {
  height: 20px;
  background: #e0f2f1;
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  border: 1px solid #b2dfdb;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4fc3f7 0%, #29b6f6 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: width 0.3s ease;
}

.progress-text {
  color: white;
  font-size: 12px;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.refresh-btn {
  background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
  color: white;
  border: none;
  border-radius: 15px;
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
}

.refresh-btn:hover {
  background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(25, 118, 210, 0.4);
}

.refresh-btn:active {
  transform: translateY(0);
}

.refresh-icon {
  font-size: 16px;
  animation: rotate 0.5s ease-in-out;
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.refresh-btn:hover .refresh-icon {
  animation: rotate 0.5s ease-in-out;
}

/* Additional styles for new interface */
.loading-spinner {
  display: none;
  text-align: center;
  color: #c62828;
}

/* Notification Badge */
.notification-badge { 
  position: fixed;
  bottom: 60px;
  right: 20px;
  background: #c62828;
  color: white;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(198, 40, 40, 0.3);
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  z-index: 1000;
}

.notification-badge:hover {
  background: #a21820;
  transform: scale(1.05);
}

/* Panel Toggle */
.panel-toggle {
  display: none;
}

/* Notification Panel - Always use the manual control via JavaScript */
.notification-panel {
  position: fixed;
  right: 20px;
  top: 20px;
  width: 350px;
  max-height: 80vh;
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  transform: translateX(100%);
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
  z-index: 1001;
  overflow: hidden;
}

.notification-header {
  background: #c62828;
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-notification {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s ease;
}

.close-notification:hover {
  background: rgba(255,255,255,0.2);
}

.notification-content {
  max-height: calc(80vh - 80px);
  overflow-y: auto;
  padding: 10px;
}

/* Nearby User Cards */
.nearby-user {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px;
  margin-bottom: 8px;
  background: #f8f9fa;
  border-radius: 12px;
  transition: background 0.2s ease;
}

.nearby-user:hover {
  background: #e9ecef;
}

.user-info {
  display: flex;
  align-items: center;
  flex: 1;
}


.user-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex-shrink: 0;
}

.btn-add {
  background: #28a745;
  color: white;
  border: none;
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-add:hover {
  background: #218838;
  transform: translateY(-2px);
}

.btn-pending {
  background: #ffc107;
  color: #212529;
  border: none;
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-pending:hover {
  background: #e0a800;
  transform: translateY(-2px);
}

.btn-friend {
  background: #0a984a;
  color: white;
  border: none;
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 20px;
  cursor: not-allowed;
  transition: all 0.3s ease;
}

.btn-connect-disabled {
  background: #6c757d;
  color: #adb5bd;
  border: none;
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 20px;
  cursor: not-allowed;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.user-pic {
  width: 45px;
  height: 45px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin-right: 12px;
  border: 2px solid #e9ecef;
}

.user-details h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.user-details p {
  margin: 4px 0;
  font-size: 12px;
  color: #666;
}

.user-interests {
  font-size: 11px;
  color: #888;
  display: block;
  margin-top: 2px;
}

.btn-connect {
  background: #043A54;
  color: white;
  border: none;
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.btn-connect:hover {
  background: #75A8C5;
  transform: translateY(-2px);
}

/* Custom Scrollbar for notification */
.notification-content::-webkit-scrollbar {
  width: 4px;
}

.notification-content::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.notification-content::-webkit-scrollbar-thumb {
  background: #c62828;
  border-radius: 2px;
}

/* Custom Leaflet Popup Styling */
.leaflet-popup-content-wrapper {
  border-radius: 15px !important;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
  border: 2px solid #BC0126 !important;
}

.leaflet-popup-content {
  margin: 0 !important;
  padding: 0 !important;
  border-radius: 15px !important;
}

.leaflet-popup-tip {
  background: #BC0126 !important;
}
</style>
{% endblock %}

{% block content %}


<!-- Hidden checkboxes for panel toggle -->
<input type="checkbox" id="notification-toggle" class="panel-toggle">

<!-- Notification Badge for Nearby Users -->
<label for="notification-toggle" class="notification-badge" title="Nearby Users" onclick="toggleNotificationPanel()">üì¢</label>

<!-- Notification Panel for Nearby Users -->
<div class="notification-panel" id="notification-panel">
  <div class="notification-header">
    <h3>People Nearby</h3>
    <button class="close-notification" onclick="closeNotificationPanel()">√ó</button>
  </div>
  <div class="notification-content">
    {% if nearby_users %}
      {% for user_data in nearby_users %}
      <div class="nearby-user">
        <div class="user-info">
          <div class="user-pic">
            {% if user_data.user.avatar %}
            <img src="{{ user_data.user.avatar.url }}" alt="{{ user_data.user.full_name }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />
            {% else %}
              {% if user_data.user.gender == 'male' %}üë¶{% elif user_data.user.gender == 'female' %}üëß{% else %}üë§{% endif %}
            {% endif %}
          </div>
          <div class="user-details">
            <h4>{{ user_data.user.full_name|default:user_data.user.username }}</h4>
            <p>üìç {{ user_data.distance|floatformat:1 }}km away ‚Ä¢ {% if user_data.user.status == 'online' %}Online{% else %}Active {{ user_data.user.last_seen|timesince }} ago{% endif %}</p>
            <span class="user-interests">
              {% if user_data.user.bio %}üí≠ {{ user_data.user.bio|truncatechars:30 }}{% else %}üéµ Music ‚Ä¢ üçú Food{% endif %}
            </span>
          </div>
        </div>
       <div class="user-actions">
          {% if user_data.friend_status == 'friends' %}
            <button class="btn-friend" disabled>
              Friends
            </button>
          {% elif user_data.friend_status == 'sent' %}
            <button 
              class="btn-pending" 
              onclick="cancelFriendRequest('{{ user_data.request_id }}')"
              id="friend-btn-{{ user_data.user.id }}"
            >
              Sent
            </button>
          {% elif user_data.friend_status == 'received' %}
            <button 
              class="btn-add" 
              onclick="showRequestActions('{{ user_data.request_id }}')"
              id="friend-btn-{{ user_data.user.id }}"
            >
              Respond
            </button>
          {% else %}
            <button
              class="btn-add"
              onclick="addFriend('{{ user_data.user.id }}')"
              id="friend-btn-{{ user_data.user.id }}"
            >
              Add
            </button>
          {% endif %}
          
          {% if user_data.friend_status == 'friends' %}
            <button
              class="btn-connect"
              onclick="startChat('{{ user_data.user.id }}')"
            >
              Chat
            </button>
          {% else %}
            <button class="btn-connect-disabled" disabled>
              Chat
            </button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="nearby-user">
        <div class="user-info">
          <div class="user-pic">üîç</div>
          <div class="user-details">
            <h4>No users nearby</h4>
            <p>Try expanding your search radius</p>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Level Control Panel -->
<div class="level-control-panel">
  <div class="level-info">
    <div class="level-badge">
      <span class="level-icon">üèÜ</span>
      <span class="level-text">Level {{ user_level|default:1 }}</span>
    </div>
    <div class="search-info">
      <span class="search-icon">üéØ</span>
      <span class="search-text">Search Radius: {{ search_radius|default:5 }}km</span>
    </div>
  </div>
  <div class="level-progress">
    <div class="progress-info">
      <span class="range-text">Current Range: {{ search_radius|default:5 }}km (Based on Level {{ user_level|default:1 }})</span>
      <span class="next-level">‚¨ÜÔ∏è Next Level {{ next_level|default:2 }}: {{ next_level_radius|default:7 }}km radius</span>
      <span class="level-up-hint">‚≠ê Level up to expand your search area!</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" style="width: 85%;">
        <span class="progress-text">{{ search_radius|default:5 }}km</span>
      </div>
    </div>
  </div>
  <button class="refresh-btn" onclick="window.location.reload()">
    <span class="refresh-icon">üîÑ</span>
    <span>Refresh</span>
  </button>
</div>

<!-- Content Panels -->
<div class="panels">
  <!-- Mission Panel -->
  <div class="content-panel mission-panel">
    <div class="panel-header">Mission</div>
    <div class="panel-content">
      <div class="event-card">
        <h3>Daily Check-in</h3>
        <p>Start your day by checking in and earning points for consistent engagement.</p>
        <button class="btn-connect" onclick="window.location.href='{% url 'gamification:mission_list' %}'">See more</button>
      </div>
      <div class="event-card">
        <h3>Help a Newcomer</h3>
        <p>Guide someone new to the community and earn mentor badges.</p>
        <button class="btn-connect" onclick="window.location.href='{% url 'gamification:mission_list' %}'">See more</button>
      </div>
      <div class="event-card">
        <h3>Share Your Story</h3>
        <p>Tell your journey and inspire others in the community.</p>
        <button class="btn-connect" onclick="window.location.href='{% url 'gamification:mission_list' %}'">See more</button>
      </div>
      <div class="event-card">
        <h3>Local Explorer</h3>
        <p>Discover and review local Vietnamese businesses and services.</p>
        <button class="btn-connect" onclick="window.location.href='{% url 'gamification:mission_list' %}'">See more</button>
      </div>
    </div>
  </div>

  <!-- Event Panel -->
  <div class="content-panel event-panel">
    <div class="panel-header">Event</div>
    <div class="panel-content">
      <div class="event-card">
        <h3>Meet & Greet</h3>
        <p>Meet, mingle, and expand your network in the Vietnamese community in Japan.</p>
        <button class="btn-connect" onclick="alert('Event details coming soon!')">See more</button>
      </div>
      <div class="event-card">
        <h3>Career Workshop</h3>
        <p>Learn job-hunting skills and explore career opportunities in Japan.</p>
        <button class="btn-connect" onclick="alert('Event details coming soon!')">See more</button>
      </div>
      <div class="event-card">
        <h3>Culture Day</h3>
        <p>Experience Vietnamese culture through food, games, and music.</p>
        <button class="btn-connect" onclick="alert('Event details coming soon!')">See more</button>
      </div>
      <div class="event-card">
        <h3>Language Exchange</h3>
        <p>Practice Japanese and Vietnamese with native speakers in a friendly environment.</p>
        <button class="btn-connect" onclick="alert('Event details coming soon!')">See more</button>
      </div>
    </div>
  </div>

  <!-- Achievement Panel -->
  <div class="content-panel achievement-panel">
    <div class="panel-header">Achievement List</div>
    <div class="panel-content">
      <div class="event-card">
        <h3>Community Builder</h3>
        <p>Earned for helping 10 new members get started in the community.</p>
        <button class="btn-connect" onclick="alert('Achievement details coming soon!')">View Badge</button>
      </div>
      <div class="event-card">
        <h3>Event Organizer</h3>
        <p>Successfully organized your first community event with 20+ attendees.</p>
        <button class="btn-connect" onclick="alert('Achievement details coming soon!')">View Badge</button>
      </div>
      <div class="event-card">
        <h3>Cultural Ambassador</h3>
        <p>Shared Vietnamese culture and traditions with the broader community.</p>
        <button class="btn-connect" onclick="alert('Achievement details coming soon!')">View Badge</button>
      </div>
      <div class="event-card">
        <h3>Mentor of the Month</h3>
        <p>Recognized for outstanding support and guidance to community members.</p>
        <button class="btn-connect" onclick="alert('Achievement details coming soon!')">View Badge</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden map container for the original map functionality -->
<div id="map" style="position: absolute; top: 0; left: 80px; right: 0; bottom: 0; z-index: 1;"></div>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-2">Scanning for nearby friends...</p>
</div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let isUpdating = false;


    const nearbyUsers = JSON.parse('{{ map_users_json|escapejs }}');
    const currentUser = JSON.parse('{{ current_user_json|escapejs }}');
    let map = null; // Variable to store map object
    let searchRadiusCircle = null; // Variable to store search radius circle
    
    
    document.addEventListener('DOMContentLoaded', function() {
  const toggles = document.querySelectorAll('.panel-toggle');
  const buttons = document.querySelectorAll('label.sidebar-btn');

  // Handle panel toggles for other buttons
  toggles.forEach((toggle, index) => {
    toggle.addEventListener('change', function() {
      if (this.checked) {
        toggles.forEach((otherToggle, otherIndex) => {
          if (otherIndex !== index) {
            otherToggle.checked = false;
            if (buttons[otherIndex]) {
              buttons[otherIndex].classList.remove('active');
            }
          }
        });
        if (buttons[index]) {
          buttons[index].classList.add('active');
        }
      } else {
        if (buttons[index]) {
          buttons[index].classList.remove('active');
        }
      }
    });
  });


// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
    profileDropdown.classList.remove('show');
  }
});
});




    function initializeMap() {
        // Check if current user has coordinates
        if (!currentUser.latitude || !currentUser.longitude) {
            document.getElementById('map').innerHTML = '<div class="p-4 text-center text-muted">Please update your location to view the map.</div>';
            return;
        }

        // Initialize map and set view to current user position
        map = L.map('map').setView([currentUser.latitude, currentUser.longitude], 13);

        // Th√™m l·ªõp tile layer t·ª´ OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // T·∫°o icon t√πy ch·ªânh cho ng∆∞·ªùi d√πng hi·ªán t·∫°i
        const currentUserIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3037/3037402.png', // M·ªôt icon v·ªã tr√≠ ƒë·∫∑c bi·ªát
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -40]
        });

        // ƒê√°nh d·∫•u v·ªã tr√≠ ng∆∞·ªùi d√πng hi·ªán t·∫°i
        L.marker([currentUser.latitude, currentUser.longitude], {icon: currentUserIcon}).addTo(map)
            .bindPopup('<b>V·ªã tr√≠ c·ªßa b·∫°n</b>')
            .openPopup();

        // V·∫Ω v√≤ng tr√≤n b√°n k√≠nh t√¨m ki·∫øm
        searchRadiusCircle = L.circle([currentUser.latitude, currentUser.longitude], {
            color: '#45b7d1',
            fillColor: '#45b7d1',
            fillOpacity: 0.1,
            radius: currentUser.search_radius * 1000 // Chuy·ªÉn t·ª´ km sang m√©t
        }).addTo(map);

        // Th√™m c√°c marker cho ng∆∞·ªùi d√πng g·∫ßn ƒë√≥
        nearbyUsers.forEach(user => {
            const userIcon = L.icon({
                iconUrl: user.avatar_url,
                iconSize: [35, 35],
                className: 'user-map-avatar' // Th√™m class ƒë·ªÉ style n·∫øu mu·ªën
            });

            const marker = L.marker([user.latitude, user.longitude]).addTo(map);
            
            // T·∫°o popup hi·ªÉn th·ªã th√¥ng tin khi click v·ªõi logic t∆∞∆°ng t·ª± nearby users list
            let friendButton = '';
            let chatButton = '';
            
            // Logic cho n√∫t k·∫øt b·∫°n - s·ª≠ d·ª•ng friend_status ho·∫∑c fallback
            const friendStatus = user.friend_status || 'none';
            const requestId = user.request_id || '';
            
            if (friendStatus === 'friends') {
                friendButton = `<button class="btn btn-sm btn-success" disabled style="background: #0a984a; color: white; border: none; padding: 6px 12px; font-size: 11px; border-radius: 15px; margin-right: 5px;">Friends</button>`;
            } else if (friendStatus === 'sent') {
                friendButton = `<button class="btn btn-sm btn-warning" onclick="cancelFriendRequest('${requestId}')" style="background: #ffc107; color: #212529; border: none; padding: 6px 12px; font-size: 11px; border-radius: 15px; margin-right: 5px;">Sent</button>`;
            } else if (friendStatus === 'received') {
                friendButton = `<button class="btn btn-sm btn-primary" onclick="showRequestActions('${requestId}')" style="background: #28a745; color: white; border: none; padding: 6px 12px; font-size: 11px; border-radius: 15px; margin-right: 5px;">Respond</button>`;
            } else {
                friendButton = `<button class="btn btn-sm btn-success" onclick="addFriend('${user.id}')" id="popup-friend-btn-${user.id}" style="background: #28a745; color: white; border: none; padding: 6px 12px; font-size: 11px; border-radius: 15px; margin-right: 5px;"><i class="fas fa-user-plus"></i> Add</button>`;
            }
            
            // Logic cho n√∫t chat
            if (friendStatus === 'friends') {
                chatButton = `<button class="btn btn-sm btn-info" onclick="startChat('${user.id}')" style="background: #043A54; color: white; border: none; padding: 6px 12px; font-size: 11px; border-radius: 15px;"><i class="fas fa-comment"></i> Chat</button>`;
            } else {
                chatButton = `<button class="btn btn-sm btn-secondary" disabled style="background: #6c757d; color: #adb5bd; border: none; padding: 6px 12px; font-size: 11px; border-radius: 15px; cursor: not-allowed;">Chat</button>`;
            }

            // T·∫°o bio display v·ªõi fallback
            const bioText = user.bio ? user.bio : (user.interests ? user.interests : '');
            const bioDisplay = bioText ? `<p style="margin: 5px 0; font-size: 11px; color: #888; font-style: italic;">"${bioText.length > 30 ? bioText.substring(0, 30) + '...' : bioText}"</p>` : '';

            const popupContent = `
                <div class="text-center" style="min-width: 200px; padding: 10px;">
                    <img src="${user.avatar_url}" alt="${user.full_name}" width="60" class="rounded-circle mb-2" style="border: 2px solid #BC0126;">
                    <h6 style="margin: 8px 0; font-weight: 600; color: #333;">${user.full_name}</h6>
                    <p style="margin: 5px 0; font-size: 12px; color: #666;">üìç ${user.distance}km away</p>
                    ${bioDisplay}
                    <div style="margin-top: 10px; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;">
                        ${friendButton}
                        ${chatButton}
                    </div>
                </div>
            `;
            marker.bindPopup(popupContent);
        });
    }

    // G·ªçi h√†m kh·ªüi t·∫°o map khi trang t·∫£i xong
    document.addEventListener('DOMContentLoaded', initializeMap);


      // Level-based radius - no manual update needed
      function updateRadius(value) {
        // Radius is now based on user level, not manual input
        console.log("Radius is determined by user level:", "{{ search_radius }}");
      }

      function updateMapRadius(radiusKm) {
        // C·∫≠p nh·∫≠t v√≤ng tr√≤n b√°n k√≠nh tr√™n map
        if (searchRadiusCircle && map) {
          searchRadiusCircle.setRadius(radiusKm * 1000); // Chuy·ªÉn t·ª´ km sang m√©t
        }
      }

      function updateSearchRadius(radius) {
        if (isUpdating) return;
        isUpdating = true;

        fetch("/users/update-search-radius/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ radius: radius }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // C·∫≠p nh·∫≠t currentUser.search_radius v·ªõi gi√° tr·ªã m·ªõi
              currentUser.search_radius = radius;
              refreshNearbyUsers();
            }
          })
          .finally(() => {
            isUpdating = false;
          });
      }

      function refreshLocation() {
        const btn = document.getElementById("refreshBtn");
        const spinner = document.getElementById("loadingSpinner");

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        spinner.style.display = "block";

        if ("geolocation" in navigator) {
          // Options for high accuracy location
          const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0 // Don't use cached location
          };
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              console.log("üìç Location obtained:", position.coords.latitude, position.coords.longitude);
              console.log("üéØ Accuracy:", position.coords.accuracy, "meters");
              
              updateUserLocation(
                position.coords.latitude,
                position.coords.longitude
              );
            },
            (error) => {
              console.error("‚ùå Location error:", error);
              let errorMessage = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i. ";
              switch(error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage += "Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ trong tr√¨nh duy·ªát.";
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage += "Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.";
                  break;
                case error.TIMEOUT:
                  errorMessage += "Y√™u c·∫ßu l·∫•y v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian.";
                  break;
                default:
                  errorMessage += "L·ªói kh√¥ng x√°c ƒë·ªãnh.";
                  break;
              }
              console.warn(errorMessage);
              refreshNearbyUsers();
            },
            geoOptions
          );
        } else {
          refreshNearbyUsers();
        }
      }


    

      function updateUserLocation(lat, lng) {
        console.log("üì§ Sending location update to server:", lat, lng);
        
        fetch("/users/update-location/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ latitude: lat, longitude: lng }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("‚úÖ Location updated successfully on server");
              refreshNearbyUsers();
            } else {
              console.error("‚ùå Failed to update location:", data.message);
            }
          })
          .catch((error) => {
            console.error("‚ùå Network error updating location:", error);
          });
      }

      function updateMapWithNewData() {
        console.log("üó∫Ô∏è Updating map with new data without page reload");
        // Map will be updated by the refreshNearbyUsers function
        // This prevents the page reload while keeping data fresh
      }

      function refreshNearbyUsers() {
        fetch("/users/nearby/")
          .then((response) => response.text())
          .then((html) => {
            // Update the users list
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, "text/html");
            const newUsersList = newDoc.getElementById("usersList");
            
            if (newUsersList) {
              document.getElementById("usersList").innerHTML = newUsersList.innerHTML;
              console.log("‚úÖ Updated nearby users list without page reload");
            }
            
            // Update map data without reload by re-initializing
            updateMapWithNewData();
          })
          .finally(() => {
            document.getElementById("refreshBtn").disabled = false;
            document.getElementById("refreshBtn").innerHTML =
              '<i class="fas fa-sync-alt"></i> Refresh';
            document.getElementById("loadingSpinner").style.display = "none";
          });
      }

      function addFriend(userId) {
        const btn = document.getElementById(`friend-btn-${userId}`);
        const originalContent = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = 'Sending...';

        fetch("/social/send-friend-request/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ user_id: userId }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("üéâ Friend request sent!");
            } else {
              alert("‚ùå " + data.message);
            }
          });
      }

      // Function to start chat with a user
      function startChat(userId) {
        window.location.href = `/social/chat/${userId}/`;
      }

      // Notification Panel Functions
      function toggleNotificationPanel() {
        const panel = document.getElementById('notification-panel');
        const toggle = document.getElementById('notification-toggle');
        
        if (panel && toggle) {
          toggle.checked = !toggle.checked;
          
          if (toggle.checked) {
            panel.style.transform = 'translateX(0)';
            panel.style.opacity = '1';
            panel.style.pointerEvents = 'auto';
            console.log('Panel opened');
          } else {
            panel.style.transform = 'translateX(100%)';
            panel.style.opacity = '0';
            panel.style.pointerEvents = 'none';
            console.log('Panel closed');
          }
        }
      }

      function closeNotificationPanel() {
        const panel = document.getElementById('notification-panel');
        const toggle = document.getElementById('notification-toggle');
        
        if (panel && toggle) {
          toggle.checked = false;
          panel.style.transform = 'translateX(100%)';
          panel.style.opacity = '0';
          panel.style.pointerEvents = 'none';
          console.log('Panel closed via button');
        }
      }

      // Close panel when clicking outside
      document.addEventListener('click', function(e) {
        const panel = document.getElementById('notification-panel');
        const badge = document.querySelector('.notification-badge');
        const toggle = document.getElementById('notification-toggle');
        
        if (panel && badge && toggle) {
          if (!panel.contains(e.target) && !badge.contains(e.target) && toggle.checked) {
            closeNotificationPanel();
          }
        }
      });

      function updateLocationAndRefresh() {
        refreshLocation();
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Auto-detect location when page loads for better accuracy
      function autoDetectLocation() {
        console.log("üîç Auto-detecting location for better accuracy...");
        
        if ("geolocation" in navigator) {
          const geoOptions = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0 // Always get fresh location
          };
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const accuracy = Math.round(position.coords.accuracy);
              console.log("üìç Auto-detected location:", position.coords.latitude, position.coords.longitude);
              console.log("üéØ Accuracy:", accuracy, "meters");
              
              // Always update location, but warn if accuracy is poor
              if (accuracy > 500) {
                console.warn("‚ö†Ô∏è Location accuracy is poor:", accuracy, "meters");
                console.log("üí° Try moving to an open area or enabling high accuracy GPS");
              } else {
                console.log("‚úÖ Good location accuracy:", accuracy, "meters");
              }
              
              updateUserLocation(
                position.coords.latitude,
                position.coords.longitude
              );
            },
            (error) => {
              console.warn("‚ö†Ô∏è Auto location detection failed:", error.message);
              console.log("üí° You can manually refresh location using the Refresh button");
            },
            geoOptions
          );
        } else {
          console.error("‚ùå Geolocation not supported by this browser");
        }
      }

      // Run auto-detection when page loads
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for page to fully load
        setTimeout(autoDetectLocation, 1000);
      });

      // Friend Request Functions
      function addFriend(userId) {
        const btn = document.getElementById(`friend-btn-${userId}`);
        const originalContent = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        
        fetch('/social/send-friend-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            btn.className = 'btn-pending';
            btn.innerHTML = 'Sent';
            btn.onclick = () => cancelFriendRequest(data.request_id);
            showNotification(data.message, 'success');
          } else {
            btn.disabled = false;
            btn.innerHTML = originalContent;
            showNotification(data.message, 'error');
          }
        })
        .catch(error => {
          btn.disabled = false;
          btn.innerHTML = originalContent;
          showNotification('Error sending friend request', 'error');
        });
      }
      
      function cancelFriendRequest(requestId) {
        if (!confirm('Cancel friend request?')) return;
        
        fetch('/social/cancel-friend-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ request_id: requestId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload(); // Refresh to update UI
          } else {
            showNotification(data.message, 'error');
          }
        });
      }
      
      function showRequestActions(requestId) {
        if (confirm('Accept this friend request?')) {
          respondToRequest(requestId, 'accept');
        } else if (confirm('Reject this friend request?')) {
          respondToRequest(requestId, 'reject');
        }
      }
      
      function respondToRequest(requestId, action) {
        fetch('/social/respond-friend-request/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 
            request_id: requestId, 
            action: action 
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification(data.message, 'success');
            location.reload(); // Refresh to update UI
          } else {
            showNotification(data.message, 'error');
          }
        });
      }
      
      function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} notification-popup`;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          min-width: 300px;
          animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
          ${message}
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // Reduced auto-refresh to every 5 minutes to avoid interference
      setInterval(refreshNearbyUsers, 300000);
    </script>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}


