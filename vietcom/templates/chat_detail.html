{% extends 'base.html' %} {% load static %} {% block extra_css %}
<style>
  @import url("https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&display=swap");

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Baloo 2", Arial, sans-serif !important;
  }

  body {
    background: #f5f5f5;
    overflow: hidden;
  }

  /* Chat Layout */
  .chat-container {
    position: absolute;
    left: 80px;
    top: 0;
    width: calc(100% - 80px);
    height: 100vh;
    display: flex;
  }

  .friends-list {
    width: 320px;
    background: #fff;
    border-right: 1px solid #ddd;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
  }

  .friends-list h3 {
    padding: 20px;
    background: #c62828;
    color: white;
    font-size: 18px;
    font-weight: 700;
    margin: 0;
  }

  .friends-container {
    flex: 1;
    overflow-y: auto;
  }

  .friend {
    padding: 16px 20px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
  }

  .friend:hover {
    background: #f8f9fa;
    text-decoration: none;
    color: inherit;
  }

  .friend.active {
    background: #f0f0f0;
  }

  .friend-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }

  .friend-avatar-placeholder {
    width: 50px;
    height: 50px;
    background: #c62828;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
  }

  .friend-info {
    flex: 1;
  }

  .friend-name {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 2px;
  }

  .friend-status {
    font-size: 12px;
    color: #666;
  }

  .chat-window {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fafafa;
  }

  /* Chat header */
  .chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 16px 20px;
    border-bottom: 1px solid #ddd;
  }

  .chat-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .chat-header-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
  }

  .chat-header-avatar-placeholder {
    width: 45px;
    height: 45px;
    background: #c62828;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
  }

  .chat-name {
    font-weight: 800;
    font-size: 18px;
    margin-bottom: 2px;
  }

  .chat-status {
    font-size: 12px;
    color: #666;
  }

  .chat-header button {
    background: #c62828;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .chat-header button:hover {
    background: #a21820;
  }

  .chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fafafa;
  }

  .message {
    margin-bottom: 15px;
    display: flex;
  }

  .message.sent {
    justify-content: flex-end;
  }

  .message.received {
    justify-content: flex-start;
  }

  .message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 20px;
    position: relative;
    word-wrap: break-word;
  }

  .message.sent .message-bubble {
    background: #c62828;
    color: white;
    border-bottom-right-radius: 6px;
  }

  .message.received .message-bubble {
    background: white;
    color: #333;
    border-bottom-left-radius: 6px;
    border: 1px solid #ddd;
  }

  .message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 6px;
  }

  .message img {
    max-width: 200px;
    max-height: 200px;
    border-radius: 12px;
    margin-bottom: 8px;
  }

  .chat-input {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    border-top: 1px solid #ddd;
    background: #fff;
    gap: 12px;
  }

  .chat-input button.emoji-btn,
  .chat-input button.image-btn {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .chat-input button.emoji-btn:hover,
  .chat-input button.image-btn:hover {
    background: #f0f0f0;
  }

  .chat-input input[type="text"] {
    flex: 1;
    padding: 12px 16px;
    border-radius: 25px;
    border: 1px solid #ddd;
    outline: none;
    font-size: 14px;
  }

  .chat-input input[type="text"]:focus {
    border-color: #c62828;
  }

  .chat-input .send-btn {
    background: #c62828;
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 12px 24px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .chat-input .send-btn:hover {
    background: #a21820;
  }

  /* Empty chat state */
  .empty-chat {
    text-align: center;
    color: #666;
    padding: 60px 20px;
  }

  .empty-chat i {
    font-size: 64px;
    margin-bottom: 20px;
    color: #ddd;
  }

  .empty-chat h3 {
    font-weight: 600;
    margin-bottom: 10px;
  }

  /* Image preview */
  .image-preview {
    position: relative;
    display: inline-block;
    margin-top: 10px;
  }

  .image-preview img {
    max-width: 200px;
    max-height: 200px;
    border-radius: 10px;
  }

  .image-preview button {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #c62828;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Emoji picker */
  .emoji-picker {
    position: absolute;
    bottom: 80px;
    left: 20px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    max-width: 320px;
    z-index: 1000;
    display: none;
  }

  .emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
  }

  .emoji-item {
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    text-align: center;
    transition: background-color 0.2s;
  }

  .emoji-item:hover {
    background-color: #f0f0f0;
  }

  /* No friends styling */
  .no-friends {
    text-align: center;
    padding: 60px 20px;
  }

  .no-friends i {
    font-size: 64px;
    color: #ddd;
    margin-bottom: 20px;
  }

  .no-friends h3 {
    font-weight: 600;
    margin-bottom: 10px;
    color: #333;
  }

  .no-friends p {
    color: #666;
    margin-bottom: 20px;
  }

  .btn-find-friends {
    background: #c62828;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-find-friends:hover {
    background: #a21820;
    color: white;
    text-decoration: none;
  }
</style>
{% endblock %} {% block content %}
<!-- Chat container -->
<div class="chat-container">
  <div class="friends-list">
    <h3>Friends Online</h3>
    <div class="friends-container">
      {% if friends %} {% for friend_item in friends %}
      <a
        href="{% url 'chat_detail' friend_item.id %}"
        class="friend {% if friend_item.id == friend.id %}active{% endif %}"
      >
        {% if friend_item.avatar %}
        <img
          src="{{ friend_item.avatar.url }}"
          alt="Avatar"
          class="friend-avatar"
        />
        {% else %}
        <div class="friend-avatar-placeholder">ğŸ‘¤</div>
        {% endif %}
        <div class="friend-info">
          <div class="friend-name">{{ friend_item.get_display_name }}</div>
          <div class="friend-status">
            {{ friend_item.status|default:"Online" }}
          </div>
        </div>
      </a>
      {% endfor %} {% else %}
      <div class="no-friends">
        <i class="fas fa-users"></i>
        <h3>ChÆ°a cÃ³ báº¡n bÃ¨ nÃ o</h3>
        <p>HÃ£y káº¿t báº¡n Ä‘á»ƒ báº¯t Ä‘áº§u chat!</p>
        <a href="{% url 'nearby_users' %}" class="btn-find-friends">
          TÃ¬m báº¡n bÃ¨
        </a>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="chat-window">
    <!-- Chat header -->
    <div class="chat-header">
      <div class="chat-header-info">
        {% if friend.avatar %}
        <img
          src="{{ friend.avatar.url }}"
          alt="Avatar"
          class="chat-header-avatar"
        />
        {% else %}
        <div class="chat-header-avatar-placeholder">ğŸ‘¤</div>
        {% endif %}
        <div>
          <div class="chat-name">{{ friend.get_display_name }}</div>
          <div class="chat-status">{{ friend.status|default:"Online" }}</div>
        </div>
      </div>
      <button onclick="initiateCall({{ friend.id }})" title="Gá»i Ä‘iá»‡n">
        ğŸ“ Call
      </button>
    </div>

    <!-- Chat messages -->
    <div class="chat-messages" id="chatMessages">
      {% for message in messages %}
      <div
        class="message {% if message.sender == user %}sent{% else %}received{% endif %}"
        data-message-id="{{ message.id }}"
      >
        <div class="message-bubble">
          {% if message.type == 'image' and message.image %}
          <img src="{{ message.image.url }}" alt="Image" />
          {% if message.content %}
          <div>{{ message.content }}</div>
          {% endif %} {% else %}
          <div>{{ message.content }}</div>
          {% endif %}
          <div class="message-time">{{ message.created_at|date:"H:i" }}</div>
        </div>
      </div>
      {% empty %}
      <div class="empty-chat">
        <i class="fas fa-comments"></i>
        <h3>ChÆ°a cÃ³ tin nháº¯n nÃ o</h3>
        <p>HÃ£y báº¯t Ä‘áº§u cuá»™c trÃ² chuyá»‡n!</p>
      </div>
      {% endfor %}
    </div>

    <!-- Chat input -->
    <div class="chat-input">
      <form
        method="POST"
        enctype="multipart/form-data"
        id="chatForm"
        style="display: flex; align-items: center; gap: 12px; width: 100%"
      >
        {% csrf_token %}
        <button
          type="button"
          class="emoji-btn"
          id="emojiBtn"
          title="Chá»n emoji"
        >
          ğŸ˜Š
        </button>
        <button
          type="button"
          class="image-btn"
          onclick="document.getElementById('imageInput').click()"
          title="Gá»­i áº£nh"
        >
          ğŸ–¼
        </button>
        <input
          type="text"
          name="content"
          placeholder="Type a message..."
          id="messageInput"
        />
        <input
          type="file"
          name="image"
          id="imageInput"
          accept="image/*"
          style="display: none"
        />
        <button type="submit" class="send-btn">Send</button>
      </form>

      <!-- Image preview -->
      <div id="imagePreview" class="image-preview" style="display: none">
        <img id="previewImg" src="" alt="Preview" />
        <button type="button" onclick="clearImagePreview()">Ã—</button>
      </div>

      <!-- Emoji picker -->
      <div id="emojiPicker" class="emoji-picker">
        <div class="emoji-grid">
          <span class="emoji-item">ğŸ˜€</span><span class="emoji-item">ğŸ˜ƒ</span
          ><span class="emoji-item">ğŸ˜„</span><span class="emoji-item">ğŸ˜</span>
          <span class="emoji-item">ğŸ˜†</span><span class="emoji-item">ğŸ˜…</span
          ><span class="emoji-item">ğŸ¤£</span><span class="emoji-item">ğŸ˜‚</span>
          <span class="emoji-item">ğŸ™‚</span><span class="emoji-item">ğŸ™ƒ</span
          ><span class="emoji-item">ğŸ˜‰</span><span class="emoji-item">ğŸ˜Š</span>
          <span class="emoji-item">ğŸ˜‡</span><span class="emoji-item">ğŸ¥°</span
          ><span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ¤©</span>
          <span class="emoji-item">ğŸ˜˜</span><span class="emoji-item">ğŸ˜—</span
          ><span class="emoji-item">ğŸ˜š</span><span class="emoji-item">ğŸ˜™</span>
          <span class="emoji-item">ğŸ˜‹</span><span class="emoji-item">ğŸ˜›</span
          ><span class="emoji-item">ğŸ˜œ</span><span class="emoji-item">ğŸ¤ª</span>
          <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ¤‘</span
          ><span class="emoji-item">ğŸ¤—</span><span class="emoji-item">ğŸ¤­</span>
          <span class="emoji-item">ğŸ¤«</span><span class="emoji-item">ğŸ¤”</span
          ><span class="emoji-item">ğŸ¤</span><span class="emoji-item">ğŸ¤¨</span>
          <span class="emoji-item">ğŸ˜</span><span class="emoji-item">ğŸ˜‘</span
          ><span class="emoji-item">ğŸ˜¶</span><span class="emoji-item">ğŸ˜</span>
          <span class="emoji-item">ğŸ˜’</span><span class="emoji-item">ğŸ™„</span
          ><span class="emoji-item">ğŸ˜¬</span><span class="emoji-item">ğŸ¤¥</span>
          <span class="emoji-item">ğŸ‘‹</span><span class="emoji-item">ğŸ¤š</span
          ><span class="emoji-item">ğŸ–ï¸</span><span class="emoji-item">âœ‹</span>
          <span class="emoji-item">ğŸ‘Œ</span><span class="emoji-item">ğŸ¤</span
          ><span class="emoji-item">âœŒï¸</span><span class="emoji-item">ğŸ¤</span>
          <span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ‘</span
          ><span class="emoji-item">âœŠ</span><span class="emoji-item">ğŸ‘Š</span>
          <span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ™Œ</span
          ><span class="emoji-item">ğŸ‘</span><span class="emoji-item">ğŸ¤²</span>
          <span class="emoji-item">â¤ï¸</span><span class="emoji-item">ğŸ§¡</span
          ><span class="emoji-item">ğŸ’›</span><span class="emoji-item">ğŸ’š</span>
          <span class="emoji-item">ğŸ’™</span><span class="emoji-item">ğŸ’œ</span
          ><span class="emoji-item">ğŸ¤</span><span class="emoji-item">ğŸ–¤</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Call Modals -->
{% include 'call_modal.html' %}

<script>


  // =================== CHAT FUNCTIONS ===================
  let lastMessageId = 0;
  let isPolling = false;

  // Auto scroll to bottom of messages
  function scrollToBottom() {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Format message HTML
  function formatMessage(message) {
      const messageClass = message.is_sent ? 'sent' : 'received';
      let messageContent = '';

      if (message.type === 'image' && message.image_url) {
          messageContent = `<img src="${message.image_url}" alt="Image">`;
          if (message.content) {
              messageContent += `<div>${message.content}</div>`;
          }
      } else {
          messageContent = message.content;
      }

      return `
        <div class="message ${messageClass}" data-message-id="${message.id}">
          <div class="message-bubble">
            <div>${messageContent}</div>
            <div class="message-time">${message.created_at}</div>
          </div>
        </div>
      `;
  }

  // Get new messages via AJAX
  function fetchNewMessages() {
      if (isPolling) return;

      isPolling = true;
      const friendId = {{ friend.id|escapejs }};
      const url = `/social/api/chat/${friendId}/messages/`;

      fetch(url + (lastMessageId ? `?last_message_id=${lastMessageId}` : ''))
          .then(response => response.json())
          .then(data => {
              if (data.messages && data.messages.length > 0) {
                  const chatMessages = document.getElementById("chatMessages");

                  data.messages.forEach(message => {
                      if (message.id > lastMessageId) {
                          chatMessages.insertAdjacentHTML('beforeend', formatMessage(message));
                          lastMessageId = Math.max(lastMessageId, message.id);
                      }
                  });

                  scrollToBottom();
              }
          })
          .catch(error => {
              console.error('Error fetching messages:', error);
          })
          .finally(() => {
              isPolling = false;
          });
  }

  // Initialize last message ID from existing messages
  function initializeLastMessageId() {
      const messages = document.querySelectorAll('.message[data-message-id]');
      if (messages.length > 0) {
          let maxId = 0;
          messages.forEach(msg => {
              const msgId = parseInt(msg.getAttribute('data-message-id'));
              if (msgId > maxId) {
                  maxId = msgId;
              }
          });
          lastMessageId = maxId;
      }
  }

  // Handle form submission with AJAX
  function handleFormSubmit(event) {
      event.preventDefault();

      const form = event.target;
      const formData = new FormData(form);
      const content = formData.get('content').trim();
      const image = formData.get('image');

      if (!content && !image) {
          alert('Vui lÃ²ng nháº­p tin nháº¯n hoáº·c chá»n áº£nh!');
          return;
      }

      fetch(form.action || window.location.href, {
          method: 'POST',
          body: formData,
          headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              form.querySelector('input[name="content"]').value = '';
              form.querySelector('input[name="image"]').value = '';
              clearImagePreview();
              setTimeout(fetchNewMessages, 100);
          } else {
              alert(data.error || 'CÃ³ lá»—i xáº£y ra khi gá»­i tin nháº¯n');
          }
      })
      .catch(error => {
          console.error('Error sending message:', error);
          alert('CÃ³ lá»—i xáº£y ra khi gá»­i tin nháº¯n');
      });
  }

  // Image preview functions
  function clearImagePreview() {
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('imageInput').value = '';
  }

  // Emoji picker functions
  function toggleEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
  }

  function insertEmoji(emoji) {
      const input = document.getElementById('messageInput');
      const cursorPos = input.selectionStart;
      const textBefore = input.value.substring(0, cursorPos);
      const textAfter = input.value.substring(cursorPos);
      input.value = textBefore + emoji + textAfter;
      input.focus();
      input.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
      toggleEmojiPicker();
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", function() {
      scrollToBottom();
      initializeLastMessageId();

      // Set up form handler
      const chatForm = document.getElementById('chatForm');
      if (chatForm) {
          chatForm.addEventListener('submit', handleFormSubmit);
      }

      // Set up image preview
      const imageInput = document.getElementById('imageInput');
      if (imageInput) {
          imageInput.addEventListener('change', function(e) {
              const file = e.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      document.getElementById('previewImg').src = e.target.result;
                      document.getElementById('imagePreview').style.display = 'block';
                  };
                  reader.readAsDataURL(file);
              }
          });
      }

      // Set up emoji picker
      const emojiBtn = document.getElementById('emojiBtn');
      if (emojiBtn) {
          emojiBtn.addEventListener('click', toggleEmojiPicker);
      }

      // Set up emoji selection
      const emojiItems = document.querySelectorAll('.emoji-item');
      emojiItems.forEach(item => {
          item.addEventListener('click', function() {
              insertEmoji(this.textContent);
          });
      });

      // Close emoji picker when clicking outside
      document.addEventListener('click', function(e) {
          const picker = document.getElementById('emojiPicker');
          const btn = document.getElementById('emojiBtn');
          if (!picker.contains(e.target) && e.target !== btn) {
              picker.style.display = 'none';
          }
      });

      // Start polling for new messages
      fetchNewMessages();
      setInterval(fetchNewMessages, 3000);

      // Start polling for incoming calls
      setInterval(checkIncomingCalls, 2000);
  });

  // =================== CALL FUNCTIONS ===================

  let currentCall = null;
  let localStream = null;
  let peerConnection = null;
  let isMuted = false;
  let callTimer = null;
  let callStartTime = null;

  // ICE servers configuration
  const iceServers = {
      iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
      ]
  };

  // Initiate a call
  async function initiateCall(friendId) {
      try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

          const response = await fetch('/social/call/initiate/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              },
              body: `friend_id=${friendId}`
          });

          const data = await response.json();

          if (data.success) {
              currentCall = data.call_id;
              document.getElementById('outgoing-caller-name').textContent = data.friend_name;

              const modal = new bootstrap.Modal(document.getElementById('outgoingCallModal'));
              modal.show();

              pollCallStatus();
              await setupPeerConnection();

          } else {
              alert(data.error);
              if (localStream) {
                  localStream.getTracks().forEach(track => track.stop());
              }
          }
      } catch (error) {
          console.error('Error initiating call:', error);
          alert('KhÃ´ng thá»ƒ truy cáº­p microphone. Vui lÃ²ng kiá»ƒm tra quyá»n truy cáº­p.');
      }
  }

  // Setup WebRTC peer connection
  async function setupPeerConnection() {
      peerConnection = new RTCPeerConnection(iceServers);

      localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
      });

      peerConnection.ontrack = (event) => {
          console.log('Received remote stream');
      };

      peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
              console.log('ICE candidate:', event.candidate);
          }
      };
  }

  // Answer incoming call
  async function answerCall() {
      try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

          const response = await fetch('/social/call/answer/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              },
              body: `call_id=${currentCall}`
          });

          const data = await response.json();

          if (data.success) {
              bootstrap.Modal.getInstance(document.getElementById('incomingCallModal')).hide();

              const modal = new bootstrap.Modal(document.getElementById('activeCallModal'));
              modal.show();

              await setupPeerConnection();
              startCallTimer();

          } else {
              alert(data.error);
          }
      } catch (error) {
          console.error('Error answering call:', error);
          alert('KhÃ´ng thá»ƒ truy cáº­p microphone.');
      }
  }

  // Reject incoming call
  async function rejectCall() {
      const response = await fetch('/social/call/reject/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: `call_id=${currentCall}`
      });

      bootstrap.Modal.getInstance(document.getElementById('incomingCallModal')).hide();
      cleanupCall();
  }

  // End calls
  async function endOutgoingCall() {
      await endCall();
      bootstrap.Modal.getInstance(document.getElementById('outgoingCallModal')).hide();
  }

  async function endActiveCall() {
      await endCall();
      bootstrap.Modal.getInstance(document.getElementById('activeCallModal')).hide();
  }

  async function endCall() {
      if (currentCall) {
          const response = await fetch('/social/call/end/', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              },
              body: `call_id=${currentCall}`
          });
      }

      cleanupCall();
  }

  // Clean up call resources
  function cleanupCall() {
      if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
      }

      if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
      }

      if (callTimer) {
          clearInterval(callTimer);
          callTimer = null;
      }

      currentCall = null;
      callStartTime = null;
      isMuted = false;
  }

  // Toggle mute
  function toggleMute() {
      if (localStream) {
          const audioTrack = localStream.getAudioTracks()[0];
          if (audioTrack) {
              audioTrack.enabled = !audioTrack.enabled;
              isMuted = !audioTrack.enabled;

              const muteIcon = document.getElementById('muteIcon');
              const muteIconActive = document.getElementById('muteIconActive');

              if (isMuted) {
                  if (muteIcon) muteIcon.className = 'fas fa-microphone-slash';
                  if (muteIconActive) muteIconActive.className = 'fas fa-microphone-slash';
              } else {
                  if (muteIcon) muteIcon.className = 'fas fa-microphone';
                  if (muteIconActive) muteIconActive.className = 'fas fa-microphone';
              }
          }
      }
  }

  // Start call timer
  function startCallTimer() {
      callStartTime = Date.now();
      callTimer = setInterval(updateCallTimer, 1000);
  }

  // Update call timer
  function updateCallTimer() {
      if (callStartTime) {
          const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

          const timer = document.getElementById('call-timer');
          const activeTimer = document.getElementById('active-call-timer');

          if (timer) timer.textContent = timeString;
          if (activeTimer) activeTimer.textContent = timeString;
      }
  }

  // Poll call status
  function pollCallStatus() {
      const statusInterval = setInterval(async () => {
          if (!currentCall) {
              clearInterval(statusInterval);
              return;
          }

          try {
              const response = await fetch(`/social/call/${currentCall}/status/`);
              const data = await response.json();

              if (data.status === 'active') {
                  bootstrap.Modal.getInstance(document.getElementById('outgoingCallModal')).hide();

                  const modal = new bootstrap.Modal(document.getElementById('activeCallModal'));
                  modal.show();

                  startCallTimer();
                  clearInterval(statusInterval);

              } else if (data.status === 'rejected' || data.status === 'ended') {
                  bootstrap.Modal.getInstance(document.getElementById('outgoingCallModal')).hide();
                  cleanupCall();
                  clearInterval(statusInterval);

                  if (data.status === 'rejected') {
                      alert('Cuá»™c gá»i bá»‹ tá»« chá»‘i');
                  }
              }
          } catch (error) {
              console.error('Error polling call status:', error);
          }
      }, 1000);
  }

  // Check for incoming calls
  async function checkIncomingCalls() {
      try {
          const response = await fetch('/social/call/check-incoming/');
          const data = await response.json();

          if (data.incoming_calls && data.incoming_calls.length > 0) {
              const incomingCall = data.incoming_calls[0];

              if (!currentCall) {
                  currentCall = incomingCall.call_id;
                  document.getElementById('incoming-caller-name').textContent = incomingCall.caller_name;

                  const modal = new bootstrap.Modal(document.getElementById('incomingCallModal'));
                  modal.show();
              }
          }
      } catch (error) {
          console.error('Error checking incoming calls:', error);
      }
  }
</script>

{% endblock %}
